<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telão - Votação</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --primary: #002d62; 
            --bg: #f0f2f5;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --gold: #fbbf24;
            --silver: #94a3b8;
            --bronze: #b45309;
        }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 10vh; z-index: 10; }
        .logo img { height: 60px; }
        .event-title { font-family: 'Oswald'; font-size: 2em; color: var(--primary); text-transform: uppercase; }
        
        /* MAIN CONTENT */
        main { flex: 1; padding: 40px; display: grid; grid-template-columns: 350px 1fr; gap: 40px; height: 90vh; overflow: hidden; }
        
        /* SIDEBAR (INFO) - Esquerda */
        .info-sidebar { display: flex; flex-direction: column; gap: 30px; justify-content: center; }
        
        .pauta-card { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: left; border-left: 10px solid var(--primary); }
        .pauta-label { font-size: 1.2em; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .pauta-title { font-size: 2.2em; font-weight: 800; color: var(--primary); line-height: 1.1; word-wrap: break-word; }
        
        .status-card { padding: 30px; border-radius: 20px; text-align: center; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); animation: popIn 0.5s; }
        .status-label { font-size: 1em; opacity: 0.9; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .status-value { font-family: 'Oswald'; font-size: 3.5em; font-weight: 700; line-height: 1; }
        
        .total-votes { text-align: center; font-size: 1.5em; color: var(--primary); font-weight: 800; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* CONTENT AREA (Direita) - Muda conforme o tipo */
        .content-area { background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; position: relative; display: flex; flex-direction: column; justify-content: center; }
        
        /* ESTILO PARA GRÁFICO (VOTAÇÃO SIMPLES) */
        .chart-container { width: 100%; height: 100%; position: relative; }

        /* ESTILO PARA RANKING (ELEIÇÃO) */
        .scoreboard-header { display: flex; justify-content: space-between; padding-bottom: 20px; border-bottom: 2px solid #f0f2f5; margin-bottom: 20px; font-family: 'Oswald'; color: #64748b; font-size: 1.2em; letter-spacing: 1px; }
        .score-list { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 10px; max-height: 100%; }
        .score-item { display: flex; align-items: center; padding: 15px 20px; border-radius: 15px; background: #f8fafc; position: relative; overflow: hidden; transition: all 0.3s ease; border: 1px solid #e2e8f0; flex-shrink: 0; }
        .score-bar { position: absolute; top: 0; left: 0; height: 100%; background: rgba(0, 45, 98, 0.05); z-index: 0; transition: width 1s ease; }
        .pos-badge { width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; color: #64748b; font-family: 'Oswald'; font-size: 1.5em; display: flex; align-items: center; justify-content: center; margin-right: 20px; z-index: 1; font-weight: bold; flex-shrink: 0; }
        .name { flex: 1; font-size: 1.8em; font-weight: 700; color: var(--primary); z-index: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .votes { font-family: 'Oswald'; font-size: 2.2em; font-weight: 700; color: var(--primary); z-index: 1; background: white; padding: 5px 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-width: 80px; text-align: center; }

        /* Destaques Ranking */
        .rank-1 .pos-badge { background: var(--gold); color: white; box-shadow: 0 4px 10px rgba(251, 191, 36, 0.4); }
        .rank-1 .score-bar { background: rgba(251, 191, 36, 0.1); }
        .rank-1 { border: 2px solid var(--gold); transform: scale(1.01); }
        .rank-2 .pos-badge { background: var(--silver); color: white; }
        .rank-3 .pos-badge { background: var(--bronze); color: white; }

        /* STATUS COLORS */
        .st-aberta { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .st-aprovada { background: linear-gradient(135deg, #10b981, #059669); }
        .st-reprovada { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .st-empate { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .st-encerrada { background: #64748b; }
        .st-concluida { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }

        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; color: #94a3b8; grid-column: 1 / -1; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="logo"><img src="/static/logo-pe.svg" alt="Logo"></div>
            <div class="event-title">${ eventoNome }</div>
        </header>

        <main v-if="pauta">
            <div class="info-sidebar">
                <div class="pauta-card">
                    <div class="pauta-label">${ pauta.tipo === 'ELEICAO' ? 'Eleição' : 'Votação' }</div>
                    <div class="pauta-title">${ pauta.titulo }</div>
                </div>

                <div :class="['status-card', getStatusClass()]">
                    <div class="status-label">Situação</div>
                    <div class="status-value">${ pauta.resultado_final === 'ANDAMENTO' ? pauta.status : pauta.resultado_final }</div>
                </div>

                <div class="total-votes">
                    <i class="ph ph-users-three" style="font-size: 1.5em;"></i>
                    <div>
                        <div style="font-size: 0.5em; text-transform: uppercase; color: #666; font-weight: 600;">Total Computado</div>
                        ${ pauta.total_votos }
                    </div>
                </div>
            </div>

            <div class="content-area">
                
                <div v-if="pauta.tipo === 'SIMPLES'" class="chart-container">
                    <canvas id="graficoTelao"></canvas>
                </div>

                <div v-else class="ranking-wrapper" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="scoreboard-header">
                        <span>CANDIDATO</span>
                        <span>VOTOS</span>
                    </div>
                    <div class="score-list">
                        <div v-for="(item, index) in ranking" :key="item.nome" :class="['score-item', 'rank-' + (index+1)]">
                            <div class="score-bar" :style="{ width: getPercentage(item.votos) + '%' }"></div>
                            <div class="pos-badge">${ index + 1 }º</div>
                            <div class="name">${ item.nome }</div>
                            <div class="votes">${ item.votos }</div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <main v-else>
            <div class="empty-state">
                <i class="ph ph-presentation-chart" style="font-size: 6em; margin-bottom: 20px; opacity: 0.5;"></i>
                <h1 style="font-size: 2em; opacity: 0.7;">Aguardando Início...</h1>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        Chart.register(ChartDataLabels);

        createApp({
            delimiters: ['${', '}'],
            data() { return { pauta: null, eventoNome: 'Assembleia', chart: null } },
            computed: {
                ranking() {
                    if(!this.pauta || !this.pauta.resultados) return [];
                    return Object.entries(this.pauta.resultados)
                        .map(([nome, votos]) => ({ nome, votos }))
                        .sort((a, b) => b.votos - a.votos);
                },
                maxVotes() {
                    if (this.ranking.length === 0) return 1;
                    return this.ranking[0].votos || 1; 
                }
            },
            methods: {
                async fetchData() {
                    try {
                        const r = await axios.get('/api/telao-dados');
                        this.eventoNome = r.data.evento;
                        const novaPauta = r.data.pauta;
                        
                        if (!this.pauta || (novaPauta && (this.pauta.titulo !== novaPauta.titulo || this.pauta.tipo !== novaPauta.tipo))) {
                            this.pauta = novaPauta;
                            if (this.pauta && this.pauta.tipo === 'SIMPLES') {
                                this.renderChart();
                            } else {
                                if(this.chart) { this.chart.destroy(); this.chart = null; }
                            }
                        } else {
                            this.pauta = novaPauta;
                            if (this.pauta && this.pauta.tipo === 'SIMPLES') {
                                this.updateChartData();
                            }
                        }
                    } catch (e) { console.error(e); }
                },
                getStatusClass() {
                    if (!this.pauta) return '';
                    const st = this.pauta.status;
                    const res = this.pauta.resultado_final;
                    if (st === 'ABERTA') return 'st-aberta';
                    if (res === 'APROVADA') return 'st-aprovada';
                    if (res === 'REPROVADA') return 'st-reprovada';
                    if (res === 'EMPATE') return 'st-empate';
                    if (res.includes('CONCLUÍDA')) return 'st-concluida';
                    return 'st-encerrada';
                },
                getPercentage(votes) {
                    return (votes / this.maxVotes) * 100;
                },
                renderChart() {
                    this.$nextTick(() => {
                        const ctx = document.getElementById('graficoTelao');
                        if (!ctx) return;
                        
                        if (this.chart) this.chart.destroy();

                        const labels = Object.keys(this.pauta.resultados).map(l => l.toUpperCase());
                        const data = Object.values(this.pauta.resultados);

                        const bgColors = labels.map(l => {
                            if(l==='FAVOR' || l==='SIM') return '#10b981'; 
                            if(l==='CONTRA' || l==='NAO') return '#ef4444'; 
                            if(l==='ABSTENCAO') return '#94a3b8'; 
                            return '#3b82f6';
                        });

                        this.chart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: bgColors,
                                    borderWidth: 0,
                                    borderRadius: 8,
                                    hoverOffset: 10
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: { padding: 40 },
                                plugins: {
                                    legend: { 
                                        position: 'bottom', 
                                        labels: { font: { size: 18, weight: 'bold' }, padding: 30 } 
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { weight: 'bold', size: 32 },
                                        formatter: (value, ctx) => {
                                            if (value === 0) return '';
                                            let sum = 0;
                                            let dataArr = ctx.chart.data.datasets[0].data;
                                            dataArr.map(data => { sum += data; });
                                            return (value*100 / sum).toFixed(0)+"%";
                                        }
                                    }
                                }
                            }
                        });
                    });
                },
                updateChartData() {
                    if (this.chart) {
                        this.chart.data.datasets[0].data = Object.values(this.pauta.resultados);
                        this.chart.update();
                    } else {
                        this.renderChart();
                    }
                }
            },
            mounted() {
                this.fetchData();
                setInterval(this.fetchData, 2000);
            }
        }).mount('#app');
    </script>
</body>
</html>
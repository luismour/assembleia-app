<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vota√ß√£o Escoteira</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@500;700;800&family=Oswald:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-blue: #002d62; --scout-purple: #6a1b9a; --bg-color: #f4f7f9; --white: #ffffff; --success: #10b981; --danger: #dc2626; --gray: #9ca3af; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; margin: 0; padding: 0; color: #1f2937; min-height: 100vh; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        .splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-blue) 0%, #1e1b4b 100%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; transition: opacity 0.6s ease, transform 0.6s ease; }
        .splash-logo { width: 140px; filter: brightness(0) invert(1); margin-bottom: 40px; animation: pulseLogo 3s infinite; }
        .splash-title { font-family: 'Oswald', sans-serif; font-size: 2.5em; text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        .splash-btn { margin-top: 60px; padding: 18px 50px; background: white; color: var(--primary-blue); border: none; border-radius: 50px; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.1em; box-shadow: 0 10px 25px rgba(0,0,0,0.3); cursor: pointer; animation: slideUp 1s ease-out; }
        .splash-hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        .app-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
        .header-logo { height: 40px; width: auto; }
        .header-brand { font-family: 'Oswald', sans-serif; color: var(--primary-blue); font-size: 1.2em; text-transform: uppercase; letter-spacing: 1px; }
        .main-container { flex: 1; padding: 20px; padding-bottom: 100px; display: flex; flex-direction: column; justify-content: center; max-width: 500px; margin: 0 auto; width: 100%; }
        .event-hero { background: linear-gradient(135deg, var(--primary-blue), var(--scout-purple)); color: white; padding: 20px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(106, 27, 154, 0.2); text-align: center; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .event-label { position: relative; font-size: 0.75em; text-transform: uppercase; opacity: 0.8; font-weight: 600; letter-spacing: 1.5px; display: block; margin-bottom: 5px; }
        .event-name { position: relative; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.4em; line-height: 1.2; margin: 0; }
        .card { background: white; border-radius: 24px; padding: 30px 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.08); text-align: center; border: 1px solid rgba(255,255,255,0.5); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .login-icon { font-size: 4em; margin-bottom: 15px; display: block; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        .input-wrapper { position: relative; margin: 15px 0; }
        .cred-input { width: 100%; padding: 20px; border: 2px solid #e5e7eb; border-radius: 16px; font-size: 1.4em; text-align: center; font-family: 'Poppins', sans-serif; font-weight: 700; color: var(--primary-blue); text-transform: uppercase; transition: all 0.3s ease; background: #f9fafb; margin-bottom: 10px; }
        .cred-input:focus { border-color: var(--primary-blue); background: white; outline: none; box-shadow: 0 0 0 4px rgba(0, 45, 98, 0.1); }
        .input-error { animation: shake 0.4s ease-in-out; border-color: var(--danger); }
        .user-chip { background: #eff6ff; color: var(--primary-blue); padding: 8px 12px 8px 16px; border-radius: 30px; font-weight: 600; font-size: 0.95em; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px; border: 1px solid #dbeafe; }
        .group-tag { background: var(--primary-blue); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 800; letter-spacing: 0.5px; }
        .btn { width: 100%; padding: 20px; border: none; border-radius: 16px; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.1em; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 12px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue), #1e3a8a); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-neutral { background: linear-gradient(135deg, #9ca3af, #6b7280); }
        .status-pill { display: inline-block; padding: 6px 12px; border-radius: 8px; font-size: 0.75em; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .pill-open { background: #d1fae5; color: #065f46; border: 1px solid #bbf7d0; }
        .election-option { background: #f9fafb; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        .election-option.selected { border-color: var(--primary-blue); background: #eff6ff; box-shadow: 0 4px 10px rgba(0, 45, 98, 0.1); }
        .checkbox-fake { width: 24px; height: 24px; border-radius: 6px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; color: white; transition: 0.2s; background: white; }
        .election-option.selected .checkbox-fake { background: var(--primary-blue); border-color: var(--primary-blue); }
        .waiting-box { padding: 40px 0; }
        .radar { width: 80px; height: 80px; background: var(--primary-blue); border-radius: 50%; margin: 0 auto 20px auto; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 0 rgba(0, 45, 98, 0.7); animation: pulse-blue 2s infinite; }
        .radar-icon { font-size: 2.5em; color: white; }
        .success-box { background: #ecfdf5; border: 2px dashed #34d399; padding: 30px; border-radius: 20px; color: #064e3b; margin-top:10px; }
        .check-icon { font-size: 4em; display: block; margin-bottom: 10px; animation: bounceIn 0.6s; }
        .nav-bar { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; padding: 10px 20px; display: flex; justify-content: space-around; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-btn { background: none; border: none; color: #9ca3af; display: flex; flex-direction: column; align-items: center; font-size: 0.75em; font-weight: 600; gap: 4px; padding: 8px 15px; transition: 0.3s; cursor: pointer; }
        .nav-btn.active { color: var(--primary-blue); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(3px); animation: fadeIn 0.2s; }
        .modal-content { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 25px; max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s; padding-bottom: 40px; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } } @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 45, 98, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(0, 45, 98, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 45, 98, 0); } } @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); } } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <div class="splash-screen" :class="{ 'splash-hidden': !mostrarWelcome }">
            <img src="/static/logo-pe.svg" alt="Logo" class="splash-logo">
            <button @click="iniciarApp" class="splash-btn">INICIAR CREDENCIAMENTO</button>
        </div>

        <header class="app-header">
            <img src="/static/logo-pe.svg" alt="Logo" class="header-logo">
        </header>

        <div class="main-container">
            <div v-if="!user" class="card">
                <span class="login-icon">üîí</span>
                <h2 style="color: var(--primary-blue); margin: 0; font-family: 'Oswald'; font-size: 1.8em;">Acesso Seguro</h2>
                <p style="color: #6b7280; font-size: 0.9em; margin-bottom: 0;">Identifique-se para votar</p>
                <div class="input-wrapper">
                    <input v-model="credencial" placeholder="C√ìDIGO" class="cred-input" :class="{ 'input-error': erroLoginAnim }" @keyup.enter="login" maxlength="6" style="letter-spacing: 3px;">
                    <input v-model="cpfInput" @input="mascaraCPF" placeholder="CPF" class="cred-input" :class="{ 'input-error': erroLoginAnim }" @keyup.enter="login" inputmode="numeric" maxlength="14" style="font-size:1.2em;">
                </div>
                <button @click="login" class="btn btn-primary">ENTRAR</button>
            </div>

            <div v-else>
                <div class="event-hero">
                    <span class="event-label">VOC√ä EST√Å NO EVENTO:</span>
                    <h2 class="event-name"><span v-if="dados && dados.evento">üìç ${ dados.evento }</span><span v-else>Carregando evento...</span></h2>
                </div>

                <div class="card">
                    <div class="user-chip">
                        üë§ ${ user.nome } 
                        <span v-if="user.grupo === '00'" class="group-tag" style="background-color: #b91c1c;">Diretoria Regional</span>
                        <span v-else class="group-tag">GE ${ user.grupo }</span>
                    </div>

                    <div v-if="!dados || !dados.pauta">
                         <div class="waiting-box"><div class="radar"><span class="radar-icon">üì°</span></div><h3 style="color: #4b5563; font-size: 1.1em; margin: 0;">Aguardando Mesa...</h3></div>
                    </div>

                    <div v-else-if="dados.pauta">
                        <div v-if="dados.pauta.status === 'ABERTA'">
                            <span class="status-pill pill-open">VOTA√á√ÉO ABERTA</span>
                            <h2 style="font-family: 'Poppins'; margin: 10px 0 25px 0; line-height: 1.3;">${ dados.pauta.titulo }</h2>

                            <div v-if="dados.pode_votar">
                                <div v-if="dados.pauta.tipo === 'SIMPLES'">
                                    <button @click="votar('favor')" class="btn btn-success">üëç A FAVOR</button>
                                    <button @click="votar('contra')" class="btn btn-danger">üëé CONTRA</button>
                                    <button @click="votar('abstencao')" class="btn btn-neutral">‚úã ABSTEN√á√ÉO</button>
                                </div>
                                <div v-else>
                                    <p style="color:var(--text-muted); font-size:0.9em; margin-bottom:20px;">Selecione at√© <b>${ dados.pauta.max_escolhas }</b> candidatos:</p>
                                    <div v-for="cand in dados.pauta.candidatos" :key="cand" class="election-option" :class="{selected: selecionados.includes(cand)}" @click="toggleCand(cand)">
                                         <div class="checkbox-fake"><span v-if="selecionados.includes(cand)">‚úì</span></div><span style="font-weight:600; color:var(--primary-blue); font-size:1.1em;">${ cand }</span>
                                    </div>
                                    <button @click="confirmarEleicao" class="btn btn-primary" style="margin-top:20px;" :disabled="selecionados.length === 0">CONFIRMAR VOTO (${ selecionados.length }/${ dados.pauta.max_escolhas })</button>
                                </div>
                            </div>
                            <div v-else class="success-box"><span class="check-icon">‚úÖ</span><h3 style="margin: 0; font-family: 'Poppins';">Voto Registrado!</h3><p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.8;">Aguarde o resultado no tel√£o.</p></div>
                        </div>
                        <div v-else class="waiting-box"><div class="radar"><span class="radar-icon">‚öúÔ∏è</span></div><p style="color: #6b7280; font-weight: 600; margin-bottom: 5px;">AGUARDANDO ABERTURA</p><h3 style="color: var(--primary-blue); font-size: 1.2em; margin: 0;">${ dados.pauta.titulo }</h3></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="user" class="nav-bar">
            <button class="nav-btn" :class="{active: view === 'votar'}" @click="view = 'votar'"><span class="nav-icon">üó≥Ô∏è</span> Votar</button>
            <button class="nav-btn" :class="{active: view === 'historico'}" @click="carregarHistorico"><span class="nav-icon">üïí</span> Hist√≥rico</button>
            <button class="nav-btn" @click="sair"><span class="nav-icon">üö™</span> Sair</button>
        </div>

        <div v-if="view === 'historico'" class="modal-overlay" @click.self="view = 'votar'">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2 style="color: var(--primary-blue); margin:0;">Meu Hist√≥rico</h2><button @click="view = 'votar'" style="background:#f3f4f6; border:none; padding:8px 15px; border-radius:10px; font-weight:bold;">‚úï</button></div>
                <div v-if="historico.length === 0" style="text-align:center; color:#999; padding:30px;">Nenhum voto registrado ainda.</div>
                <div v-for="h in historico" :key="h.titulo" style="background:#f9fafb; padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid #e5e7eb;">
                    <div style="font-weight:700; color:#374151; margin-bottom:8px; line-height:1.2;">${ h.titulo }</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-size:0.75em; background:#e5e7eb; padding:4px 10px; border-radius:6px; font-weight:600; color:#4b5563;">${ h.status }</span><div style="text-align:right;"><span v-for="v in h.votos" style="font-size:0.8em; font-weight:bold; text-transform:uppercase; color:#002d62; display:block;">${ v }</span></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['${', '}'],
            data() { 
                return { 
                    mostrarWelcome: true, 
                    credencial: '', 
                    cpfInput: '', 
                    user: null, 
                    dados: null, 
                    view: 'votar', 
                    historico: [], 
                    erroLoginAnim: false, 
                    selecionados: [], 
                    hbInterval: null, 
                    pollInterval: null,
                    authToken: null 
                } 
            },
            methods: {
                iniciarApp() { this.mostrarWelcome = false; },
                mascaraCPF(e) {
                    let v = e.target.value.replace(/\D/g, "");
                    if (v.length > 11) v = v.slice(0, 11);
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                    this.cpfInput = v;
                },
                async login() { 
                    if(!this.credencial || !this.cpfInput) return;
                    try { 
                        const res = await axios.post('/api/login', { 
                            token: this.credencial.trim().toUpperCase(), 
                            cpf: this.cpfInput 
                        }); 
                        this.user = res.data; 
                        this.authToken = this.user.token || this.credencial.trim().toUpperCase();

                        this.startHeartbeat();
                        this.poll(); 
                    } 
                    catch (e) { 
                        if(e.response && e.response.data && e.response.data.detail) alert(e.response.data.detail); 
                        else alert("Erro ao acessar. Verifique seus dados."); 
                        this.triggerShake(); 
                    } 
                },
                triggerShake() { this.erroLoginAnim = true; if (navigator.vibrate) navigator.vibrate(200); setTimeout(() => this.erroLoginAnim = false, 400); },
                toggleCand(nome) {
                    if (this.selecionados.includes(nome)) { this.selecionados = this.selecionados.filter(x => x !== nome); } else {
                        if (this.selecionados.length < this.dados.pauta.max_escolhas) { this.selecionados.push(nome); } else { if (navigator.vibrate) navigator.vibrate(200); alert(`Maximum of ${this.dados.pauta.max_escolhas} votes.`); }
                    }
                },
                async confirmarEleicao() { 
                    if (navigator.vibrate) navigator.vibrate(50); 
                    if(confirm(`Confirm vote for: ${this.selecionados.join(', ')}?`)) { this.enviarVoto(this.selecionados); } 
                },
                async votar(op) { if (navigator.vibrate) navigator.vibrate(50); if(confirm('Confirm vote?')) { this.enviarVoto(op); } },
                async enviarVoto(valorVoto) {
                    try {
                        if (!this.authToken) return alert("Erro de sess√£o. Fa√ßa login novamente.");
                        await axios.post('/api/votar', { token: this.authToken, pauta_id: this.dados.pauta.id, opcao: valorVoto }); 
                        this.celebrar(); this.selecionados = []; this.load(); 
                    } catch(e) { 
                        if (e.response && e.response.data) {
                            const d = e.response.data;
                            if (d.detail) { if (Array.isArray(d.detail)) alert("Validation Error: " + d.detail[0].msg); else alert("Notice: " + d.detail); } else { alert("Server error."); }
                        } else { alert("Connection error."); }
                    } 
                },
                celebrar() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); },
                async load() { 
                    if(!this.authToken) return; 
                    try { 
                        const res = await axios.get('/api/pauta-ativa?credencial='+this.authToken); 
                        this.dados = res.data; 
                    } catch {} 
                },
                async carregarHistorico() { 
                    this.view = 'historico'; 
                    if(!this.authToken) return;
                    try { 
                        const res = await axios.get('/api/historico?credencial='+this.authToken); 
                        this.historico = res.data; 
                    } catch {} 
                },
                async sair() { 
                    if(confirm('Deseja realmente sair?')) { 
                        try { if(this.authToken) await axios.post('/api/logout-delegado', { token: this.authToken }); } catch {}
                        this.user = null; this.dados = null; this.authToken = null; this.view = 'votar'; this.credencial = ''; this.cpfInput = ''; 
                        clearInterval(this.hbInterval); clearInterval(this.pollInterval);
                    } 
                },
                startHeartbeat() {
                    if (this.hbInterval) clearInterval(this.hbInterval);
                    this.hbInterval = setInterval(async () => {
                        if(this.authToken) {
                            try { await axios.post('/api/heartbeat', { token: this.authToken }); } catch {}
                        }
                    }, 5000);
                },
                poll() { 
                    this.load(); 
                    if (this.pollInterval) clearInterval(this.pollInterval);
                    this.pollInterval = setInterval(() => { 
                        if(this.view==='votar' && this.authToken) this.load(); 
                    }, 2000); 
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
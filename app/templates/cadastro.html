<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Cadastramento</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #002d62; --bg: #f4f7f9; --agenda: #4F46E5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; border: 1px solid rgba(255,255,255,0.5); }
        .logo { height: 60px; margin-bottom: 20px; }
        h2 { color: var(--primary); font-family: 'Oswald'; text-transform: uppercase; margin: 0 0 10px 0; font-size: 1.8em; }
        p { color: #64748b; margin-bottom: 25px; font-size: 0.95em; }
        
        label { font-weight: bold; font-size: 0.75em; color: #64748b; display: block; text-align: left; margin-bottom: 5px; margin-left: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        label span { color: #e11d48; } 

        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1em; box-sizing: border-box; font-family: 'Inter'; transition: 0.3s; background: #f8fafc; color: #334155; }
        input:focus { border-color: var(--primary); outline: none; background: white; }
        
        .btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #002d62, #1e3a8a); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 1.1em; transition: 0.2s; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .token-card { background: #ecfdf5; border: 2px dashed #10b981; padding: 20px; border-radius: 16px; margin-top: 20px; animation: slideUp 0.5s; }
        .token-val { font-family: 'Oswald'; font-size: 2.5em; color: #047857; letter-spacing: 3px; display: block; margin: 10px 0; font-weight: bold; }
        
        .btn-agenda {
            background: linear-gradient(135deg, #4F46E5, #4338ca);
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            color: white;
            padding: 15px;
            border-radius: 16px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
            font-size: 1em;
        }
        .btn-agenda:hover { filter: brightness(1.05); }

        .alert { font-size: 0.8em; background: #fff7ed; color: #c2410c; padding: 12px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffedd5; line-height: 1.4; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app" class="card">
        <img src="/static/logo-pe.svg" class="logo">
        
        <div v-if="!sucesso">
            <h2>Credenciamento</h2>
            <p>Preencha seus dados para gerar o acesso.</p>
            
            <div style="text-align: left;">
                <label>CPF <span>*</span></label>
                <input v-model="cpf" @input="mascaraCPF" placeholder="000.000.000-00" maxlength="14" inputmode="numeric">

                <label>Nome Completo <span>*</span></label>
                <input v-model="nome" placeholder="Ex: João da Silva">
                
                <label>E-mail <span>*</span></label>
                <input v-model="email" type="email" placeholder="seu@email.com">
                
                <label>Número do Grupo <span>*</span></label>
                <input v-model="grupo" type="text" inputmode="numeric" placeholder="Ex: 107 (ou 00 para Diretoria)">
            </div>

            <button @click="cadastrar" class="btn" :disabled="loading">${ loading ? 'Gerando...' : 'GERAR ACESSO' }</button>
        </div>

        <div v-else>
            <h2>Cadastro Realizado!</h2>
            <p>Salve seu código abaixo.</p>
            
            <div class="token-card">
                <span style="font-size: 0.8em; font-weight: bold; color: #065f46; letter-spacing: 1px;">SEU CÓDIGO DE ACESSO</span>
                <span class="token-val">${ tokenGerado }</span>
                <span style="font-size: 0.9em; display: block; color: #047857;">ID: <b>${ idGerado }</b></span>
            </div>

            <button @click="salvarNaAgenda" class="btn-agenda">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                SALVAR NA AGENDA
            </button>

            <div class="alert">
                ⚠️ <b>ATENÇÃO:</b> Ao salvar na agenda, seu TOKEN ficará guardado nas "notas/descrição" do evento.
            </div>

            <button @click="irParaVotacao" class="btn" style="margin-top: 20px; background: #334155;">IR PARA VOTAÇÃO</button>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            delimiters: ['${', '}'],
            data() { return { nome: '', grupo: '', cpf: '', email: '', loading: false, sucesso: false, tokenGerado: '', idGerado: '' } },
            methods: {
                mascaraCPF(e) {
                    let v = e.target.value.replace(/\D/g, "");
                    if (v.length > 11) v = v.slice(0, 11);
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d)/, "$1.$2");
                    v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                    this.cpf = v;
                },

                async cadastrar() {
                    // VALIDAÇÃO DETALHADA (Para você saber exatamente o erro)
                    if (!this.cpf) return alert("Por favor, preencha o CPF.");
                    if (!this.nome) return alert("Por favor, preencha o Nome.");
                    if (!this.email) return alert("Por favor, preencha o E-mail.");
                    if (!this.grupo) return alert("Por favor, preencha o Grupo.");

                    if (this.cpf.length < 14) return alert("CPF incompleto.");
                    
                    if (!this.email.includes('@') || !this.email.includes('.')) {
                        return alert("Por favor, digite um e-mail válido.");
                    }

                    this.loading = true;
                    try {
                        const res = await axios.post('/api/auto-cadastro', { 
                            nome: this.nome, 
                            grupo: this.grupo.toString().trim(), // Garante que envie string
                            cpf: this.cpf,
                            email: this.email 
                        });
                        
                        this.tokenGerado = res.data.token;
                        this.idGerado = res.data.id;
                        this.sucesso = true;
                    } catch (e) {
                        if (e.response && e.response.data && e.response.data.detail) {
                            alert(e.response.data.detail);
                        } else {
                            alert("Erro ao cadastrar. Verifique sua conexão.");
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                salvarNaAgenda() {
                    const titulo = "Assembleiu Odinária Regional 2026";
                    const inicio = "20260314T080000"; 
                    const fim = "20260314T170000";
                    
                    const descricao = `MEU TOKEN DE VOTAÇÃO: ${this.tokenGerado}\\nID DE USUÁRIO: ${this.idGerado}\\n\\nApresente este código na mesa de credenciamento.`;
                    const local = "UNIFG – Centro Universitário dos Guararapes (Campus Piedade), Rua Comendador José Didier, nº 27 – Piedade, Jaboatão dos Guararapes – PE";

                    const icsMsg = 
                        `BEGIN:VCALENDAR
                        VERSION:2.0
                        PRODID:-//EscoteirosPE//AppVotacao//PT
                        BEGIN:VEVENT
                        UID:${this.idGerado}@escoteirospe.com.br
                        DTSTAMP:${inicio}Z
                        DTSTART:${inicio}
                        DTEND:${fim}
                        SUMMARY:${titulo}
                        DESCRIPTION:${descricao}
                        LOCATION:${local}
                        END:VEVENT
                        END:VCALENDAR`;

                    const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.setAttribute('download', 'seminario-2026.ics');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                irParaVotacao() {
                    window.location.href = '/';
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
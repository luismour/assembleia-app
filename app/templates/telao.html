<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telão - Votação</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --primary: #002d62; 
            --bg: #f0f2f5;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
        }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 10vh; }
        .logo img { height: 60px; }
        .event-title { font-family: 'Oswald'; font-size: 2em; color: var(--primary); text-transform: uppercase; }
        
        /* MAIN CONTENT */
        main { flex: 1; padding: 40px; display: flex; gap: 40px; align-items: center; height: 80vh; }
        
        /* LEFT: CHART AREA */
        .chart-area { flex: 1.5; background: white; border-radius: 30px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .chart-container { width: 100%; height: 100%; position: relative; }
        
        /* RIGHT: INFO AREA */
        .info-area { flex: 1; display: flex; flex-direction: column; gap: 30px; height: 100%; justify-content: center; }
        
        .pauta-card { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; border-left: 10px solid var(--primary); }
        .pauta-label { font-size: 1.2em; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .pauta-title { font-size: 2.5em; font-weight: 800; color: var(--primary); line-height: 1.2; }
        
        .status-card { padding: 30px; border-radius: 20px; text-align: center; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .status-label { font-size: 1em; opacity: 0.9; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .status-value { font-family: 'Oswald'; font-size: 4em; font-weight: 700; line-height: 1; }
        
        /* STATUS COLORS */
        .st-aberta { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .st-aprovada { background: linear-gradient(135deg, #10b981, #059669); }
        .st-reprovada { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .st-empate { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .st-encerrada { background: #64748b; }

        /* TOTAL VOTES */
        .total-votes { text-align: center; font-size: 1.5em; color: var(--primary); font-weight: 800; margin-top: 20px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* NO CONTENT STATE */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; color: #94a3b8; }
        .empty-icon { font-size: 5em; margin-bottom: 20px; }
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="logo"><img src="/static/logo-pe.svg" alt="Logo"></div>
            <div class="event-title">${ eventoNome }</div>
        </header>

        <main v-if="pauta">
            <div class="chart-area">
                <div class="chart-container">
                    <canvas id="graficoTelao"></canvas>
                </div>
            </div>

            <div class="info-area">
                <div class="pauta-card">
                    <div class="pauta-label">Em Votação</div>
                    <div class="pauta-title">${ pauta.titulo }</div>
                </div>

                <div :class="['status-card', getStatusClass()]">
                    <div class="status-label">Situação</div>
                    <div class="status-value">${ pauta.resultado_final === 'ANDAMENTO' ? pauta.status : pauta.resultado_final }</div>
                </div>

                <div class="total-votes">
                    <i class="ph ph-users"></i> ${ pauta.total_votos } VOTOS REGISTRADOS
                </div>
            </div>
        </main>

        <main v-else>
            <div class="empty-state">
                <i class="ph ph-presentation-chart empty-icon"></i>
                <h1>Aguardando início da votação...</h1>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        Chart.register(ChartDataLabels); 

        createApp({
            delimiters: ['${', '}'],
            data() { return { pauta: null, eventoNome: 'Assembleia', chart: null } },
            methods: {
                async fetchData() {
                    try {
                        const r = await axios.get('/api/telao-dados');
                        this.eventoNome = r.data.evento;
                        const novaPauta = r.data.pauta;

                        if (!this.pauta || (novaPauta && this.pauta.titulo !== novaPauta.titulo)) {
                            this.pauta = novaPauta;
                            this.renderChart();
                        } else {
                            this.pauta = novaPauta;
                            this.updateChartData();
                        }
                    } catch (e) { console.error(e); }
                },
                getStatusClass() {
                    if (!this.pauta) return '';
                    const st = this.pauta.status;
                    const res = this.pauta.resultado_final;
                    
                    if (st === 'ABERTA') return 'st-aberta';
                    if (res === 'APROVADA') return 'st-aprovada';
                    if (res === 'REPROVADA') return 'st-reprovada';
                    if (res === 'EMPATE') return 'st-empate';
                    return 'st-encerrada';
                },
                renderChart() {
                    if (!this.pauta) return;
                    
                    this.$nextTick(() => {
                        const ctx = document.getElementById('graficoTelao');
                        if (!ctx) return;
                        
                        if (this.chart) this.chart.destroy();

                        const isEleicao = this.pauta.tipo === 'ELEICAO';
                        const labels = Object.keys(this.pauta.resultados);
                        const data = Object.values(this.pauta.resultados);
                        
                        const bgColors = labels.map(l => {
                            if(l==='favor') return '#10b981'; 
                            if(l==='contra') return '#ef4444'; 
                            if(l==='abstencao') return '#cbd5e1'; 
                            return this.getRandomColor(); 
                        });

                        this.chart = new Chart(ctx, {
                            type: isEleicao ? 'bar' : 'doughnut',
                            data: {
                                labels: labels.map(l => l.toUpperCase()),
                                datasets: [{
                                    data: data,
                                    backgroundColor: bgColors,
                                    borderWidth: 0,
                                    borderRadius: 5
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: { padding: 20 },
                                plugins: {
                                    legend: { 
                                        position: 'bottom', 
                                        labels: { font: { size: 16, weight: 'bold' }, padding: 20 } 
                                    },
                                    datalabels: {
                                        color: '#fff',
                                        font: { weight: 'bold', size: 24 },
                                        formatter: (value, ctx) => {
                                            if (value === 0) return '';
                                            let sum = 0;
                                            let dataArr = ctx.chart.data.datasets[0].data;
                                            dataArr.map(data => { sum += data; });
                                            let percentage = (value*100 / sum).toFixed(0)+"%";
                                            return percentage; // Retorna a % dentro da fatia
                                        }
                                    }
                                }
                            }
                        });
                    });
                },
                updateChartData() {
                    if (this.chart && this.pauta) {
                        this.chart.data.datasets[0].data = Object.values(this.pauta.resultados);
                        this.chart.update();
                    } else {
                        this.renderChart();
                    }
                },
                getRandomColor() {
                    const letters = '0123456789ABCDEF';
                    let color = '#';
                    for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
                    return color;
                }
            },
            mounted() {
                this.fetchData();
                setInterval(this.fetchData, 2000); 
            }
        }).mount('#app');
    </script>
</body>
</html>
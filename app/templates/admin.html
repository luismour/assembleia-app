<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa Diretora - PE</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary: #002d62; --primary-light: #3b5998; --accent: #0056b3;        
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;       
            --bg-body: #f4f7f9; --surface: #ffffff; --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 40px -5px rgba(0, 45, 98, 0.1);
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; color: var(--text-main); margin: 0; min-height: 100vh; padding: 20px; }

        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-body); background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; z-index: 2000; padding:0; margin:0; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 50px 40px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; box-shadow: var(--shadow-lg); border: 1px solid white; animation: slideUp 0.6s ease; }
        .login-icon-box { width: 80px; height: 80px; background: #eff6ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; color: var(--primary); font-size: 2.5em; }
        .login-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 15px; background: #f8fafc; }
        .btn-login { width: 100%; background: linear-gradient(135deg, var(--primary), #1e3a8a); color: white; padding: 16px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(0, 45, 98, 0.2); }

        .app-container { max-width: 1400px; margin: 0 auto; }
        .top-bar { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-md); margin-bottom: 30px; position: sticky; top: 10px; z-index: 100; flex-wrap: nowrap; }
        .brand { display: flex; align-items: center; gap: 15px; white-space: nowrap; } .brand img { height: 40px; } .brand-text h1 { font-family: 'Oswald'; font-size: 1.4em; margin: 0; color: var(--primary); text-transform: uppercase; line-height: 1; }
        .event-selector-wrapper { display: flex; align-items: center; gap: 12px; background: #f1f5f9; padding: 6px 15px; border-radius: 50px; border: 1px solid var(--border); margin: 0 20px; flex: 1; max-width: 400px; justify-content: space-between; }
        .header-actions { display: flex; gap: 10px; align-items: center; white-space: nowrap; }
        .btn-action { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 12px; border: none; font-size: 0.9em; font-weight: 600; cursor: pointer; color: white; text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 42px; }
        .btn-excel { background: linear-gradient(135deg, #059669, #10b981); } .btn-telao { background: linear-gradient(135deg, #7c3aed, #8b5cf6); } .btn-logout { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

        .tabs-container { display: flex; gap: 10px; margin-bottom: 25px; background: white; padding: 6px; border-radius: 16px; width: fit-content; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        .tab-btn { padding: 10px 24px; border: none; border-radius: 12px; font-weight: 600; color: var(--text-muted); cursor: pointer; background: transparent; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 380px; gap: 30px; animation: fadeIn 0.5s ease-out; }
        .card { background: var(--surface); border-radius: 20px; padding: 30px; box-shadow: var(--shadow-md); border: 1px solid rgba(255,255,255,0.6); margin-bottom: 25px; }
        .input-std { flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Inter'; font-size: 0.95em; width: 100%; }
        .btn-create { background: var(--primary); color: white; border: none; padding: 0 24px; border-radius: 12px; font-weight: 700; cursor: pointer; height: 42px; }

        .pauta-item { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px; transition: 0.2s; position: relative; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 800; text-transform: uppercase; }
        .bg-aberta { background: #dcfce7; color: #166534; } .bg-encerrada { background: #fee2e2; color: #991b1b; }
        .btn-icon-action { width: 36px; height: 36px; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px; }
        .votes-table-container { margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px; animation: slideDown 0.3s; }
        .details-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .details-table th { text-align: left; color: var(--text-muted); padding: 8px; border-bottom: 1px solid var(--border); }
        .details-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; }
        .vote-tag { font-weight: 700; font-size: 0.8em; text-transform: uppercase; }

        /* RANKING SIDEBAR */
        .ranking-list-small { max-height: 350px; overflow-y: auto; text-align: left; margin-top: 15px; padding-right: 5px; }
        .rank-item-small { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.9em; }
        .rank-item-small:last-child { border-bottom: none; }
        .rank-pos-small { font-weight: bold; color: var(--text-muted); width: 25px; }
        .rank-name-small { flex: 1; font-weight: 600; color: var(--primary); text-align: left; }
        .rank-votes-small { font-weight: 800; color: var(--success); background: #dcfce7; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .rank-elected .rank-name-small { color: var(--success); }
        .rank-elected .rank-pos-small { color: var(--primary); }

        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-window { background: white; padding: 35px; border-radius: 24px; width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.3s; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; height: 0; } to { opacity: 1; height: auto; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!token" class="login-wrapper">
            <div class="login-card">
                <div class="login-icon-box"><i class="ph ph-shield-check"></i></div>
                <h2 class="login-title">Acesso Restrito</h2>
                <form @submit.prevent="logar">
                    <input v-model="usuarioInput" class="login-input" placeholder="Usuário">
                    <input v-model="senhaInput" type="password" class="login-input" placeholder="Senha">
                    <button type="submit" class="btn-login">ENTRAR</button>
                </form>
            </div>
        </div>

        <div v-else class="app-container">
            <header class="top-bar">
                <div class="brand"><img src="/static/logo-pe.svg" alt="Logo"><div class="brand-text"></div></div>
                <div class="event-selector-wrapper">
                    <select v-model="assembleiaAtiva" @change="ativarAssembleia" style="border:none; background:transparent; font-weight:bold; color:var(--primary); outline:none; width: 100%;"><option v-for="a in assembleias" :value="a.id">${ a.titulo }</option></select>
                    <button @click="showModalAsm = true" class="btn-create" style="width:30px; height:30px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">+</button>
                </div>
                <div class="header-actions">
                    <button @click="baixarExcel" class="btn-action btn-excel"><i class="ph ph-microsoft-excel-logo"></i> <span style="display:none; @media(min-width: 1000px){display:inline;}">Relatório</span></button>
                    <a href="/telao" target="_blank" class="btn-action btn-telao"><i class="ph ph-monitor-play"></i> <span style="display:none; @media(min-width: 1000px){display:inline;}">Telão</span></a>
                    <button @click="logout" class="btn-action btn-logout"><i class="ph ph-sign-out"></i> <span style="display:none; @media(min-width: 1000px){display:inline;}">Sair</span></button>
                </div>
            </header>

            <div class="tabs-container">
                <button class="tab-btn" :class="{active: abaAtual === 'votacao'}" @click="abaAtual = 'votacao'"><i class="ph ph-gavel"></i> Votação</button>
                <button class="tab-btn" :class="{active: abaAtual === 'grupos'}" @click="abaAtual = 'grupos'"><i class="ph ph-users-three"></i> Gestão de Acesso</button>
                <button class="tab-btn" :class="{active: abaAtual === 'security'}" @click="abaAtual = 'security'"><i class="ph ph-shield-check"></i> Segurança</button>
            </div>

            <div v-show="abaAtual === 'votacao'" class="dashboard-grid">
                <div class="col-main">
                    <div class="card" style="border-left: 5px solid var(--primary);">
                        <h3 style="margin-top:0; color:var(--primary); margin-bottom: 20px;">Nova Pauta</h3>
                        <div style="display:flex; gap:20px; margin-bottom:20px; font-size:0.95em; background: #f8fafc; padding: 10px; border-radius: 10px;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight: 500;"><input type="radio" value="SIMPLES" v-model="tipoPauta"> Votação Simples</label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight: 500;"><input type="radio" value="ELEICAO" v-model="tipoPauta"> Eleição Nominal</label>
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:15px;"><input v-model="novaPautaTexto" class="input-std" placeholder="Título da Pauta ou Cargo..."></div>
                        <div v-if="tipoPauta === 'ELEICAO'" style="background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:15px; border:1px solid #e2e8f0;">
                            <div style="margin-bottom:15px; display: flex; align-items: center; gap: 10px;"><label style="font-size:0.85em; font-weight:bold; color:var(--text-muted);">MÁX. VOTOS:</label><input type="number" v-model="maxVotos" class="input-std" style="width:80px; flex: none; padding:8px;" min="1"></div>
                            <label style="font-size:0.8em; font-weight:bold; color:var(--text-muted); display:block; margin-bottom: 8px;">ADICIONAR CANDIDATOS</label>
                            <div style="display:flex; gap:10px; margin-bottom:15px;"><input v-model="novoCandidato" class="input-std" placeholder="Nome do Candidato" @keyup.enter="addCand"><button @click="addCand" class="btn-create" style="background: var(--success); width: auto;">+ Adicionar</button></div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;"><span v-for="(c,i) in listaCandidatos" :key="i" style="background:white; border:1px solid #cbd5e1; padding:6px 12px; border-radius:20px; font-size:0.9em; font-weight:600; display: flex; align-items: center; gap: 8px;">${ c } <span @click="listaCandidatos.splice(i,1)" style="color:var(--danger); cursor:pointer; font-weight: bold;">✕</span></span></div>
                        </div>
                        <button @click="criarPauta" class="btn-create" style="width:100%;">CRIAR PAUTA</button>
                    </div>

                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;"><h3 style="margin:0; color:var(--primary);">Pautas do Evento</h3><span style="background:#f1f5f9; padding:4px 12px; border-radius:20px; font-size:0.85em; font-weight: 600; color:var(--text-muted);">${ pautas.length }</span></div>
                        <div v-for="pauta in pautas" :key="pauta.id" class="pauta-item">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;"><span :class="['badge', 'bg-'+pauta.status.toLowerCase()]">${ pauta.status }</span><span style="font-size:0.7em; background:#f1f5f9; border: 1px solid #e2e8f0; padding:2px 8px; border-radius:4px; color: var(--text-muted); font-weight: 600;">${ pauta.tipo }</span></div>
                                    <h4 style="margin:0; font-size: 1.1em; color: var(--primary);">${ pauta.titulo }</h4>
                                    <span style="font-size:0.85em; color:var(--text-muted); display: block; margin-top: 4px;">Votos: <b>${ pauta.total_votos }</b> | Resultado: <b>${ pauta.resultado_final }</b></span>
                                </div>
                                <div style="display:flex; gap: 5px;">
                                    <button @click="deletarPauta(pauta.id)" class="btn-icon-action" style="background:#fef2f2; color:var(--danger);" title="Excluir"><i class="ph ph-trash"></i></button>
                                    <button @click="prepararEdicao(pauta)" class="btn-icon-action" style="background:#f0f9ff; color:var(--accent);" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                                    <div style="width: 1px; background: #e2e8f0; margin: 0 5px;"></div>
                                    <button v-if="pauta.status!=='ABERTA'" @click="mudarStatus(pauta.id,'ABERTA')" class="btn-icon-action" style="background:#dbeafe; color:#1e40af;" title="Abrir"><i class="ph ph-play"></i></button>
                                    <button v-if="pauta.status==='ABERTA'" @click="mudarStatus(pauta.id,'ENCERRADA')" class="btn-icon-action" style="background:#fee2e2; color:#991b1b;" title="Encerrar"><i class="ph ph-stop"></i></button>
                                    <button @click="toggleDetails(pauta.id)" class="btn-icon-action" style="background:#f1f5f9; color:#64748b;" title="Detalhes"><i class="ph ph-list"></i></button>
                                </div>
                            </div>
                            <div v-if="pauta.showDetails" class="votes-table-container">
                                <table class="details-table"><thead><tr><th>GE</th><th>Nome</th><th>Voto</th></tr></thead><tbody><tr v-for="v in pauta.votos_detalhados" :key="v.credencial"><td>${ v.grupo }</td><td>${ v.nome }</td><td><span class="vote-tag" :style="{color: v.voto=='favor'?'green':(v.voto=='contra'?'red':'#002d62')}">${ v.voto }</span></td></tr></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sidebar">
                    <div class="card" style="text-align:center; position:sticky; top:100px;">
                        <h3 style="color:var(--primary); margin-bottom:20px;"><i class="ph ph-chart-pie-slice"></i> Tempo Real</h3>
                        <div v-if="pautaAtiva">
                            <span :class="['badge', 'bg-'+pautaAtiva.status.toLowerCase()]" style="margin-bottom: 10px; display: inline-block;">● ${ pautaAtiva.status }</span>
                            <h4 style="margin:0 0 15px 0;">${ pautaAtiva.titulo }</h4>
                            <div v-if="pautaAtiva.tipo === 'ELEICAO'">
                                <div class="ranking-list-small">
                                    <div v-for="(cand, idx) in ranking" :key="cand.nome" class="rank-item-small" :class="{ 'rank-elected': idx < (pautaAtiva.max_escolhas || 1) }">
                                        <span class="rank-pos-small">${ idx + 1 }º</span><span class="rank-name-small">${ cand.nome }</span><span class="rank-votes-small">${ cand.votos }</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else style="height:250px;"><canvas id="graficoVotos"></canvas></div>
                            <h1 style="font-size:3em; margin:15px 0 0 0; color:var(--primary); line-height: 1;">${ pautaAtiva.total_votos }</h1>
                            <span style="text-transform:uppercase; color:var(--text-muted); font-size:0.8em; font-weight:bold;">Votos Computados</span>
                        </div>
                        <div v-else style="padding:40px 0; color:var(--text-muted); opacity:0.6;"><i class="ph ph-chart-bar" style="font-size:3em; margin-bottom: 10px;"></i><p>Nenhuma pauta ativa</p></div>
                    </div>
                </div>
            </div>

            <div v-show="abaAtual === 'grupos'" class="card" style="max-width: 1000px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:var(--primary);">Gestão de Acesso</h3>
                    <button @click="modoImpressao = !modoImpressao" class="btn-action" style="background:#475569;"><i class="ph ph-printer"></i> ${ modoImpressao ? 'Voltar' : 'Imprimir Cartões' }</button>
                </div>
                <div v-if="!modoImpressao" style="background:#f8fafc; padding:20px; border-radius:16px; margin-bottom:30px; border:1px dashed var(--border);">
                    <h4 style="margin-top:0; color:var(--text-muted); font-size:0.9em; text-transform:uppercase;">Adicionar em Massa</h4>
                    <div style="display:grid; grid-template-columns: 100px 1fr; gap:15px; margin-bottom:15px;">
                        <div><label style="font-size:0.8em; font-weight:bold;">GRUPO Nº</label><input v-model="novoGrupoInput" class="input-std" placeholder="Ex: 107"></div>
                        <div><label style="font-size:0.8em; font-weight:bold;">NOMES (Linha/Vírgula)</label><textarea v-model="nomesArea" class="input-std" rows="3" placeholder="João da Silva, Maria Souza..."></textarea></div>
                    </div>
                    <button @click="cadastrarEmMassa" class="btn-create" style="width:100%;">GERAR TOKENS</button>
                </div>
                <div v-if="!modoImpressao">
                    <div v-for="g in grupos" :key="g.numero" style="margin-bottom:20px; background:white; border:1px solid var(--border); border-radius:12px; overflow:hidden;">
                        <div style="background:#f1f5f9; padding:10px 20px; font-weight:bold; color:var(--primary); display:flex; justify-content:space-between; align-items:center;"><span>GE ${ g.numero } <span style="font-weight:normal; font-size:0.8em;">(${ g.quantidade } delegados)</span></span><button @click="removerGrupo(g.numero)" style="border:none; color:var(--danger); background:none; cursor:pointer;"><i class="ph ph-trash"></i> Grupo</button></div>
                        <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                            <thead><tr style="border-bottom:1px solid #eee; text-align:left; color:var(--text-muted);"><th style="padding:10px 20px;">Nome</th><th style="padding:10px;">ID</th><th style="padding:10px;">Token</th><th style="padding:10px; text-align:center;">Check-in</th><th style="padding:10px;">Ação</th></tr></thead>
                            <tbody><tr v-for="d in g.delegados" :key="d.token" style="border-bottom:1px solid #f9f9f9;"><td style="padding:10px 20px; font-weight:600;">${ d.nome }</td><td style="padding:10px; color:#64748b;">${ d.id }</td><td style="padding:10px; font-family:monospace; font-size:1.1em; color:var(--primary); letter-spacing:1px; font-weight:bold;">${ d.token }</td><td style="padding:10px; text-align:center;"><button @click="toggleCheckin(d.token)" :style="{background: d.checkin ? 'var(--success)' : '#e2e8f0', color: d.checkin ? 'white' : '#64748b', border:'none', padding:'6px 12px', borderRadius:'20px', fontWeight:'bold', cursor:'pointer', minWidth:'100px'}">${ d.checkin ? 'PRESENTE' : 'AUSENTE' }</button></td><td style="padding:10px;"><i class="ph ph-trash" @click="removerDelegado(d.token)" style="cursor:pointer; color:var(--danger);"></i></td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div v-if="modoImpressao">
                    <div style="text-align:center; margin-bottom:20px; color:var(--text-muted);"><p>Imprima esta página (Ctrl+P).</p></div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;">
                        <template v-for="g in grupos">
                            <div v-for="d in g.delegados" :key="d.token" style="border:1px solid #000; padding:15px; text-align:center; page-break-inside:avoid; border-radius:8px;">
                                <img src="/static/logo-pe.svg" style="height:30px; margin-bottom:10px;">
                                <h3 style="margin:0; font-size:1.1em; text-transform:uppercase;">${ d.nome }</h3><p style="margin:5px 0;">GE ${ g.numero } - ID: ${ d.id }</p>
                                <div style="margin:15px 0; border:2px dashed #000; padding:10px;"><span style="display:block; font-size:0.7em; text-transform:uppercase;">Código de Acesso</span><span style="font-family:monospace; font-size:1.8em; font-weight:800; letter-spacing:2px;">${ d.token }</span></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div v-show="abaAtual === 'security'" class="card" style="max-width: 600px; margin: 0 auto;">
                <h3 style="color:var(--primary);">Gerenciar Admins</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;"><input v-model="novoAdminUser" class="input-std" placeholder="Novo Usuário"><input v-model="novoAdminPass" type="password" class="input-std" placeholder="Senha"><button @click="criarAdmin" class="btn-create" style="padding: 0 20px;">Adicionar</button></div>
                <div v-for="adm in admins" :key="adm.usuario" style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #f1f5f9; align-items: center;"><div style="display: flex; align-items: center; gap: 10px;"><div style="width: 32px; height: 32px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);"><i class="ph ph-user"></i></div><strong>${ adm.usuario }</strong></div><button v-if="adm.usuario !== usuarioInput" @click="removerAdmin(adm.usuario)" style="border:none; background:none; color:red; cursor:pointer;"><i class="ph ph-trash"></i></button><span v-else style="font-size: 0.8em; color: var(--text-muted);">(Você)</span></div>
            </div>
        </div>

        <div v-if="showModalAsm" class="modal-backdrop" @click.self="showModalAsm = false">
            <div class="modal-window"><h3 style="margin-top:0; color:var(--primary);">Criar Novo Evento</h3><input v-model="novaAsmTitulo" class="input-std" style="width:100%; margin:20px 0;" placeholder="Título do Evento..."><div style="display:flex; justify-content:flex-end; gap:10px;"><button @click="showModalAsm = false" style="background:#eee; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">Cancelar</button><button @click="criarAssembleia" class="btn-create" style="height: auto; padding: 10px 20px;">Criar</button></div></div>
        </div>

        <div v-if="showModalEdit" class="modal-backdrop" @click.self="showModalEdit = false">
            <div class="modal-window">
                <h3 style="margin-top:0; color:var(--primary);">Editar Pauta</h3>
                <input v-model="editData.titulo" class="input-std" style="width:100%; margin-bottom:15px;" placeholder="Título...">
                <div style="display:flex; gap:15px; margin-bottom:15px; font-size:0.9em;"><label style="display:flex; align-items:center; gap:5px;"><input type="radio" value="SIMPLES" v-model="editData.tipo"> Simples</label><label style="display:flex; align-items:center; gap:5px;"><input type="radio" value="ELEICAO" v-model="editData.tipo"> Eleição</label></div>
                <div v-if="editData.tipo === 'ELEICAO'" style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0;">
                    <div style="margin-bottom:10px;"><span style="font-size:0.8em; font-weight:bold;">MÁX. VOTOS:</span><input type="number" v-model="editData.max_escolhas" class="input-std" style="width:60px; padding:5px; margin-left:10px;" min="1"></div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;"><input v-model="editNovoCandidato" class="input-std" placeholder="Novo Candidato" @keyup.enter="addCandEdit"><button @click="addCandEdit" class="btn-create" style="padding:0 15px;">+</button></div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px;"><span v-for="(c,i) in editCandidatos" :key="i" style="background:white; border:1px solid #cbd5e1; padding:4px 10px; border-radius:15px; font-size:0.85em;">${ c } <span @click="removeCandEdit(i)" style="color:red; cursor:pointer;">x</span></span></div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;"><button @click="showModalEdit = false" style="background:#eee; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">Cancelar</button><button @click="salvarEdicao" class="btn-create" style="height: auto; padding: 10px 20px;">Salvar</button></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        let chartInstance = null;
        createApp({
            delimiters: ['${', '}'],
            data() { return { 
                token: localStorage.getItem('admin_token'), usuarioInput:'admin', senhaInput:'', abaAtual:'votacao',
                pautas:[], grupos:[], assembleias:[], admins:[],
                novaPautaTexto:'', novoGrupoInput:'', novoNomeTemp:'', nomesTemp:[],
                pautaAtiva:null, assembleiaAtiva:null, showModalAsm:false, novaAsmTitulo:'',
                novoAdminUser:'', novoAdminPass:'',
                tipoPauta: 'SIMPLES', maxVotos: 1, novoCandidato: '', listaCandidatos: [],
                showModalEdit: false, editData: { id: '', titulo: '', tipo: '', max_escolhas: 1 }, editCandidatos: [], editNovoCandidato: '',
                nomesArea: '', modoImpressao: false
            }},
            computed: {
                ranking() {
                    if(!this.pautaAtiva || !this.pautaAtiva.resultados) return [];
                    if(this.pautaAtiva.tipo !== 'ELEICAO') return [];
                    return Object.entries(this.pautaAtiva.resultados).map(([nome, votos]) => ({ nome, votos })).sort((a, b) => b.votos - a.votos);
                }
            },
            methods: {
                async logar() { try { const r = await axios.post('/api/admin/login', {usuario:this.usuarioInput, senha:this.senhaInput}); this.token=r.data.token; localStorage.setItem('admin_token',this.token); this.init(); } catch{ alert('Erro login'); } },
                logout() { axios.post('/api/admin/logout'); this.token=null; localStorage.removeItem('admin_token'); },
                init() { if(this.token) { axios.defaults.headers.common['x-admin-token']=this.token; this.fetchData(); setInterval(() => { if(this.abaAtual==='votacao') this.fetchData(); }, 2000); } },
                async fetchData() { 
                    try {
                        const r1 = await axios.get('/api/dados-admin'); 
                        this.pautas = r1.data.pautas.map(novo => { const antigo = this.pautas.find(p => p.id === novo.id); return { ...novo, showDetails: antigo ? antigo.showDetails : false }; });
                        const ab = this.pautas.find(p => p.status === 'ABERTA');
                        this.pautaAtiva = ab ? ab : (this.pautas.length>0 ? this.pautas[0] : null);
                        this.updateChart();
                        const r2 = await axios.get('/api/grupos'); this.grupos = r2.data;
                        const r3 = await axios.get('/api/assembleias'); this.assembleias = r3.data.lista; this.assembleiaAtiva = r3.data.ativa;
                        if(this.abaAtual==='security') { const r4 = await axios.get('/api/admins'); this.admins = r4.data; }
                    } catch (e) { if(e.response && e.response.status===401) this.logout(); }
                },
                addCand() { if(this.novoCandidato.trim()) { this.listaCandidatos.push(this.novoCandidato.trim()); this.novoCandidato=''; } },
                async criarPauta() { 
                    if(!this.novaPautaTexto) return alert("Título?");
                    if(this.tipoPauta==='ELEICAO' && this.listaCandidatos.length<2) return alert("Mínimo 2 candidatos");
                    await axios.post('/api/pautas', { titulo:this.novaPautaTexto, tipo:this.tipoPauta, candidatos:this.listaCandidatos, max_escolhas:this.maxVotos });
                    this.novaPautaTexto=''; this.tipoPauta='SIMPLES'; this.listaCandidatos=[]; this.maxVotos=1; this.fetchData(); 
                },
                prepararEdicao(pauta) { this.editData = { id: pauta.id, titulo: pauta.titulo, tipo: pauta.tipo, max_escolhas: pauta.max_escolhas }; this.editCandidatos = [...(pauta.candidatos || [])]; this.showModalEdit = true; },
                addCandEdit() { if(this.editNovoCandidato.trim()) { this.editCandidatos.push(this.editNovoCandidato.trim()); this.editNovoCandidato=''; } },
                removeCandEdit(i) { this.editCandidatos.splice(i, 1); },
                async salvarEdicao() { await axios.put('/api/pautas/'+this.editData.id, { titulo: this.editData.titulo, tipo: this.editData.tipo, candidatos: this.editCandidatos, max_escolhas: this.editData.max_escolhas }); this.showModalEdit = false; this.fetchData(); },
                async deletarPauta(id) { if(confirm("Tem certeza que deseja excluir esta pauta?")) { await axios.delete('/api/pautas/'+id); this.fetchData(); } },
                async mudarStatus(id, st) { await axios.post(`/api/pautas/${id}/status`, {status:st}); this.fetchData(); },
                toggleDetails(id) { const p = this.pautas.find(x => x.id === id); if(p) p.showDetails = !p.showDetails; },
                async cadastrarEmMassa() {
                    if(!this.novoGrupoInput || !this.nomesArea) return alert("Preencha Grupo e Nomes");
                    const listaNomes = this.nomesArea.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);
                    if(listaNomes.length === 0) return;
                    await axios.post('/api/grupos', { numero: this.novoGrupoInput, nomes: listaNomes });
                    this.novoGrupoInput = ''; this.nomesArea = ''; alert(`${listaNomes.length} delegados gerados!`); this.fetchData();
                },
                async toggleCheckin(token) { try { await axios.post(`/api/usuarios/${token}/checkin`); this.fetchData(); } catch(e) { alert("Erro ao fazer check-in"); } },
                async removerDelegado(token) { if(confirm("Remover este delegado?")) { await axios.delete('/api/usuarios/'+token); this.fetchData(); } },
                async removerGrupo(n) { if(confirm("Remover grupo inteiro?")) { await axios.delete('/api/grupos/'+n); this.fetchData(); } },
                async criarAdmin() { if(!this.novoAdminUser) return; await axios.post('/api/admins', {usuario:this.novoAdminUser, senha:this.novoAdminPass}); this.novoAdminUser=''; this.novoAdminPass=''; this.fetchData(); },
                async removerAdmin(u) { if(confirm('Del?')) await axios.delete('/api/admins/'+u); this.fetchData(); },
                async criarAssembleia() { await axios.post('/api/assembleias', {titulo:this.novaAsmTitulo}); this.showModalAsm=false; this.novaAsmTitulo=''; this.fetchData(); },
                async ativarAssembleia() { await axios.post(`/api/assembleias/${this.assembleiaAtiva}/ativar`); this.fetchData(); },
                baixarExcel() { if(this.token) window.location.href=`/api/exportar?token=${this.token}`; },
                updateChart() {
                    if(!this.pautaAtiva) return;
                    if(this.pautaAtiva.tipo === 'ELEICAO') { if(chartInstance) { chartInstance.destroy(); chartInstance = null; } return; }
                    const ctx = document.getElementById('graficoVotos'); if(!ctx) return;
                    const labels = Object.keys(this.pautaAtiva.resultados);
                    const data = Object.values(this.pautaAtiva.resultados);
                    if(chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, { type: 'doughnut', data:{ labels:labels, datasets:[{ data:data, backgroundColor: ['#10b981','#ef4444','#ccc'], borderWidth:0, borderRadius: 5 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true, position:'bottom'}} } });
                }
            },
            mounted() { this.init(); }
        }).mount('#app');
    </script>
</body>
</html>
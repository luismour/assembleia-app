<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --admin-bg: #f3f4f6; --primary: #002d62; --white: #fff; --text: #1f2937; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--admin-bg); color: var(--text); }
        .sidebar { width: 250px; background: var(--primary); height: 100vh; position: fixed; color: white; padding: 20px; box-sizing: border-box; }
        .sidebar h2 { margin-top: 0; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .menu-item { display: block; padding: 12px 15px; color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .main-content { margin-left: 250px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-val { font-size: 2em; font-weight: bold; color: var(--primary); }
        .stat-label { color: #6b7280; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        th { color: #6b7280; font-size: 0.85em; text-transform: uppercase; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--primary); color: white; }
        .btn-danger { background: #dc2626; }
        .btn-success { background: #10b981; }
        input, select { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!token" style="height: 100vh; display: flex; align-items: center; justify-content: center; background: #e5e7eb;">
            <div class="card" style="width: 300px; text-align: center;">
                <h2>Login Admin</h2>
                <input v-model="senhaInput" type="password" placeholder="Senha Mestra" @keyup.enter="login">
                <button class="btn" style="width: 100%; margin-top: 10px;" @click="login">Entrar</button>
            </div>
        </div>

        <div v-else>
            <div class="sidebar">
                <h2>Painel Admin</h2>
                <a class="menu-item" :class="{active: view==='dashboard'}" @click="view='dashboard'">Dashboard</a>
                <a class="menu-item" :class="{active: view==='pautas'}" @click="view='pautas'">Gerenciar Pautas</a>
                <a class="menu-item" :class="{active: view==='delegados'}" @click="view='delegados'">Delegados</a>
                <a class="menu-item" :class="{active: view==='credenciamento'}" @click="view='credenciamento'">Check-in Manual</a>
                <a class="menu-item" style="margin-top: 50px; color: #fca5a5;" @click="logout">Sair</a>
            </div>

            <div class="main-content">
                <div class="header">
                    <h2>${ pageTitle }</h2>
                    <div v-if="assembleiaAtiva" style="background: #dcfce7; color: #166534; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                        Evento Ativo: ${ assembleiaAtiva.titulo }
                    </div>
                </div>

                <div v-if="view === 'dashboard'">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-val">${ stats.total_delegados || 0 }</div>
                            <div class="stat-label">Total Inscritos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val">${ stats.presentes || 0 }</div>
                            <div class="stat-label">Check-in Realizado</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val">${ stats.quorum_pct || 0 }%</div>
                            <div class="stat-label">Quórum Atual</div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 25px;">
                        <h3>Controle do Evento</h3>
                        <div v-if="!assembleiaAtiva">
                            <p>Nenhum evento iniciado.</p>
                            <input v-model="novoEventoTitulo" placeholder="Nome do Evento (Ex: Assembleia 2024)">
                            <button class="btn" @click="iniciarEvento">Iniciar Novo Evento</button>
                        </div>
                        <div v-else>
                            <button class="btn btn-danger" @click="encerrarEvento">Encerrar Evento Atual</button>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'pautas'">
                    <div class="card">
                        <h3>Nova Pauta</h3>
                        <input v-model="novaPauta.titulo" placeholder="Título da Pauta">
                        <select v-model="novaPauta.tipo">
                            <option value="SIMPLES">Simples (Favor/Contra/Abstenção)</option>
                            <option value="ELEICAO">Eleição (Múltipla Escolha)</option>
                        </select>
                        
                        <div v-if="novaPauta.tipo === 'ELEICAO'">
                            <p style="font-size: 0.9em; margin-bottom: 5px;">Candidatos (separados por vírgula):</p>
                            <input v-model="novaPauta.candidatos" placeholder="Ex: Chapa 1, Chapa 2">
                            <p style="font-size: 0.9em; margin-bottom: 5px;">Máximo de escolhas:</p>
                            <input type="number" v-model="novaPauta.max_escolhas" style="width: 80px;">
                        </div>

                        <button class="btn btn-success" @click="criarPauta">Criar Pauta</button>
                    </div>

                    <div class="card" v-for="p in pautas" :key="p.id">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 style="margin: 0;">${ p.titulo }</h3>
                                <span class="status-badge" :class="p.status === 'ABERTA' ? 'badge-green' : 'badge-red'">${ p.status }</span>
                                <span style="font-size: 0.8em; color: #666; margin-left: 10px;">${ p.tipo }</span>
                            </div>
                            <div v-if="p.status !== 'ENCERRADA'">
                                <button v-if="p.status === 'AGUARDANDO'" class="btn" @click="mudarStatusPauta(p.id, 'ABERTA')">Abrir Votação</button>
                                <button v-if="p.status === 'ABERTA'" class="btn btn-danger" @click="mudarStatusPauta(p.id, 'ENCERRADA')">Encerrar Votação</button>
                            </div>
                        </div>

                        <div v-if="p.status !== 'AGUARDANDO'" style="margin-top: 15px; background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <h4 style="margin-top: 0;">Resultados Parciais (${ p.total_votos } votos)</h4>
                            <div v-for="(votos, op) in p.resultados" :key="op" style="display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 2px;">
                                <span>${ op }</span>
                                <strong>${ votos }</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'delegados'">
                    <div class="card">
                        <h3>Lista de Inscritos</h3>
                        <input v-model="filtroDelegado" placeholder="Buscar por nome, grupo ou ID...">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Grupo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in delegadosFiltrados" :key="u.id">
                                    <td>${ u.id }</td>
                                    <td>${ u.nome }</td>
                                    
                                    <td>
                                        <span v-if="u.grupo === '00' || u.grupo == 0" style="color: #b91c1c; font-weight: bold; font-size: 0.9em;">
                                            ⚜️ Direção Regional
                                        </span>
                                        <span v-else>
                                            GE ${ u.grupo }
                                        </span>
                                    </td>
                                    
                                    <td>
                                        <span class="status-badge" :class="u.checkin ? 'badge-green' : 'badge-red'">
                                            ${ u.checkin ? 'PRESENTE' : 'AUSENTE' }
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="view === 'credenciamento'">
                    <div class="card">
                        <h3>Check-in Manual</h3>
                        <p>Use esta tela para dar presença a quem chegou sem celular ou com problemas.</p>
                        
                        <div style="display: flex; gap: 10px;">
                            <input v-model="checkinBusca" placeholder="Digite o ID (ex: 12-1) ou Nome" @keyup.enter="buscarDelegadoCheckin">
                            <button class="btn" @click="buscarDelegadoCheckin">Buscar</button>
                        </div>

                        <div v-if="delegadoEncontrado" style="margin-top: 20px; border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px;">
                            <h3 style="margin: 0;">${ delegadoEncontrado.nome }</h3>
                            <p>GE: ${ delegadoEncontrado.grupo } | ID: ${ delegadoEncontrado.id }</p>
                            
                            <div v-if="delegadoEncontrado.checkin" class="status-badge badge-green" style="display: inline-block; margin-bottom: 10px;">JÁ CREDENCIADO</div>
                            
                            <button v-if="!delegadoEncontrado.checkin" class="btn btn-success" @click="confirmarCheckin(delegadoEncontrado.id)">✅ Confirmar Presença</button>
                            <button v-else class="btn btn-danger" @click="cancelarCheckin(delegadoEncontrado.id)">❌ Cancelar Presença</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            delimiters: ['${', '}'],
            data() {
                return {
                    view: 'dashboard',
                    token: localStorage.getItem('admin_token'),
                    senhaInput: '',
                    stats: {},
                    assembleiaAtiva: null,
                    novoEventoTitulo: '',
                    pautas: [],
                    novaPauta: { titulo: '', tipo: 'SIMPLES', candidatos: '', max_escolhas: 1 },
                    delegados: [],
                    filtroDelegado: '',
                    checkinBusca: '',
                    delegadoEncontrado: null
                }
            },
            computed: {
                pageTitle() {
                    const map = { dashboard: 'Visão Geral', pautas: 'Gerenciamento de Votações', delegados: 'Delegados Inscritos', credenciamento: 'Credenciamento' }
                    return map[this.view]
                },
                delegadosFiltrados() {
                    if (!this.filtroDelegado) return this.delegados
                    const f = this.filtroDelegado.toLowerCase()
                    return this.delegados.filter(d => 
                        d.nome.toLowerCase().includes(f) || 
                        d.id.toLowerCase().includes(f) || 
                        d.grupo.toString().includes(f)
                    )
                }
            },
            async mounted() {
                if(this.token) this.loadData()
            },
            methods: {
                async login() {
                    try {
                        const res = await axios.post('/api/admin/login', { senha: this.senhaInput })
                        this.token = res.data.token
                        localStorage.setItem('admin_token', this.token)
                        this.loadData()
                    } catch { alert('Senha incorreta') }
                },
                logout() {
                    this.token = null
                    localStorage.removeItem('admin_token')
                },
                headers() { return { headers: { 'Authorization': `Bearer ${this.token}` } } },
                
                async loadData() {
                    try {
                        const r1 = await axios.get('/api/dados-admin', this.headers())
                        this.stats = r1.data.stats
                        this.assembleiaAtiva = r1.data.assembleia
                        this.pautas = r1.data.pautas || []
                        
                        const r2 = await axios.get('/api/usuarios', this.headers())
                        this.delegados = r2.data
                    } catch (e) {
                        if(e.response && e.response.status === 401) this.logout()
                    }
                },

                async iniciarEvento() {
                    if(!this.novoEventoTitulo) return alert('Digite um nome')
                    await axios.post('/api/assembleias', { titulo: this.novoEventoTitulo }, this.headers())
                    this.loadData()
                },
                async encerrarEvento() {
                    if(confirm('Tem certeza? Isso fecha o evento e gera logs.')) {
                        await axios.post(`/api/assembleias/${this.assembleiaAtiva.id}/encerrar`, {}, this.headers())
                        this.loadData()
                    }
                },

                async criarPauta() {
                    if(!this.novaPauta.titulo) return alert('Título obrigatório')
                    const payload = { ...this.novaPauta }
                    if (payload.tipo === 'ELEICAO') {
                        payload.candidatos = payload.candidatos.split(',').map(s => s.trim()).filter(s => s)
                    } else {
                        payload.candidatos = []
                    }
                    await axios.post('/api/pautas', payload, this.headers())
                    this.novaPauta = { titulo: '', tipo: 'SIMPLES', candidatos: '', max_escolhas: 1 }
                    this.loadData()
                },

                async mudarStatusPauta(id, status) {
                    await axios.put(`/api/pautas/${id}/status`, { status }, this.headers())
                    this.loadData()
                },

                async buscarDelegadoCheckin() {
                    if (!this.checkinBusca) return
                    const termo = this.checkinBusca.toLowerCase()
                    this.delegadoEncontrado = this.delegados.find(d => d.id.toLowerCase() === termo || d.nome.toLowerCase().includes(termo))
                    if (!this.delegadoEncontrado) alert('Não encontrado')
                },

                async confirmarCheckin(id) {
                    await axios.post(`/api/usuarios/${id}/checkin`, {}, this.headers())
                    alert('Check-in confirmado!')
                    this.delegadoEncontrado = null
                    this.checkinBusca = ''
                    this.loadData()
                },

                async cancelarCheckin(id) {
                    if(confirm('Remover presença?')) {
                        alert('Função de cancelamento requer implementação no backend se desejada.')
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
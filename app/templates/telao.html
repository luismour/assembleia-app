<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telão</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@400;600;800&family=Oswald:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-blue: #002d62; --header-bg: #ffffff; --header-text: #002d62; --bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #dfe4ea 100%); }
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-gradient); overflow: hidden; }
        #app { display: flex; flex-direction: column; height: 100vh; }

        .header-telao { background: var(--header-bg); color: var(--header-text); height: 100px; display: flex; justify-content: space-between; align-items: center; padding: 0 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .logo-pe { height: 70px; width: auto; }
        .live-indicator { display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 8px 20px; border-radius: 30px; border: 1px solid #e9ecef; }
        .live-dot { width: 12px; height: 12px; background-color: #e74c3c; border-radius: 50%; animation: blinkLive 1.5s infinite; }
        
        .card-telao { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); width: 100%; max-width: 1600px; height: 80vh; border-radius: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 1.2fr; gap: 40px; padding: 60px; box-sizing: border-box; align-items: center; border: 1px solid white; margin: auto; }
        
        /* STATUS */
        .status-badge { font-size: 1.2em; padding: 8px 25px; border-radius: 50px; text-transform: uppercase; font-weight: 800; display: inline-block; margin-bottom: 30px; }
        .aberta { background: #d4edda; color: #155724; } 
        .encerrada { background: #f8d7da; color: #721c24; }
        .aguardando { background: #fff3cd; color: #856404; border: 2px solid #ffeeba; } /* NOVO */

        .total-votos { font-size: 8em; font-weight: 800; color: #2c3e50; font-family: 'Poppins'; line-height: 1; letter-spacing: -2px; }
        
        /* Legenda */
        .custom-legend { display: flex; gap: 40px; margin-top: 40px; font-size: 1.8em; font-weight: 600; }
        .legend-item { display: flex; align-items: center; gap: 15px; }
        .dot { width: 25px; height: 25px; border-radius: 50%; }
        
        @keyframes blinkLive { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <header class="header-telao">
            <div style="display:flex; align-items:center; gap:25px;">
                <img src="/static/logo-pe.svg" class="logo-pe">
            </div>
            <div class="live-indicator"><div class="live-dot"></div><span style="font-family:'Poppins'; font-weight:700; color:#c0392b;">AO VIVO</span></div>
        </header>

        <div style="flex-grow:1; display:flex; justify-content:center; align-items:center; padding:40px;">
            <div v-if="!token" style="text-align:center;">
                <h2>Telão</h2><input v-model="senhaInput" type="password" placeholder="Senha" style="padding:15px; font-size:1.5em; text-align:center; border-radius:10px; border:2px solid #ccc;" @keyup.enter="logar"><br><button @click="logar" style="margin-top:20px; padding:15px 40px; font-size:1.2em; background:var(--primary-blue); color:white; border:none; border-radius:10px; font-weight:bold;">Conectar</button>
            </div>

            <div v-else-if="pautaAtiva" class="card-telao">
                <div>
                    <span :class="['status-badge', pautaAtiva.status.toLowerCase()]">${ pautaAtiva.status }</span>
                    <h1 style="font-family:'Poppins'; font-size:3.5em; font-weight:700; color:var(--primary-blue); margin:0; line-height:1.1;">${ pautaAtiva.titulo }</h1>
                    <div style="margin-top:40px;">
                        <div class="total-votos">${ pautaAtiva.total_votos }</div>
                        <div style="font-size:1.2em; text-transform:uppercase; color:#7f8c8d; font-weight:600; letter-spacing:2px; margin-top:10px;">Votos Registrados</div>
                    </div>
                    <div class="custom-legend">
                        <div class="legend-item"><span class="dot" style="background:#27ae60"></span> ${ pautaAtiva.resultados.favor }</div>
                        <div class="legend-item"><span class="dot" style="background:#c0392b"></span> ${ pautaAtiva.resultados.contra }</div>
                        <div class="legend-item"><span class="dot" style="background:#95a5a6"></span> ${ pautaAtiva.resultados.abstencao }</div>
                    </div>
                </div>
                <div style="height:100%; display:flex; justify-content:center; align-items:center;"><canvas id="graficoTelao"></canvas></div>
            </div>

            <div v-else style="text-align:center; opacity:0.6;">
                <div style="font-size:6em; color:var(--primary-blue); opacity:0.5;">⚜️</div>
                <h2 style="font-size:3em; font-family:'Oswald'; color:var(--primary-blue); margin:0;">ASSEMBLEIA REGIONAL</h2>
                <p style="font-size:1.5em; letter-spacing:1px; color:#555;">Aguardando...</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        let chartInstance = null;
        createApp({
            delimiters: ['${', '}'],
            data() { return { token: localStorage.getItem('admin_token'), senhaInput: '', pautaAtiva: null } },
            methods: {
                async logar() { try { const res = await axios.post('/api/admin/login', { senha: this.senhaInput }); this.token = res.data.token; localStorage.setItem('admin_token', this.token); this.init(); } catch { alert('Erro'); } },
                init() { if(this.token) { axios.defaults.headers.common['x-admin-token'] = this.token; this.fetchDados(); } },
                async fetchDados() {
                    try {
                        const res = await axios.get('/api/dados-admin');
                        const pautas = res.data;
                        const aberta = pautas.find(p => p.status === 'ABERTA');
                        this.pautaAtiva = aberta ? aberta : (pautas.length > 0 ? pautas[0] : null);
                        this.updateChart();
                    } catch { if(this.token) this.token = null; }
                },
                updateChart() {
                    if (!this.pautaAtiva) return;
                    this.$nextTick(() => {
                        const ctx = document.getElementById('graficoTelao');
                        if (!ctx) return;
                        const dados = [this.pautaAtiva.resultados.favor, this.pautaAtiva.resultados.contra, this.pautaAtiva.resultados.abstencao];
                        if (chartInstance) { chartInstance.data.datasets[0].data = dados; chartInstance.update(); }
                        else {
                            Chart.defaults.font.family = "'Poppins', sans-serif";
                            chartInstance = new Chart(ctx, {
                                type: 'doughnut',
                                data: { labels: ['Favor', 'Contra', 'Abstenção'], datasets: [{ data: dados, backgroundColor: ['#27ae60', '#c0392b', '#95a5a6'], borderWidth: 0 }] },
                                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '60%' }
                            });
                        }
                    });
                }
            },
            mounted() { this.init(); setInterval(() => { if(this.token) this.fetchDados(); }, 2000); }
        }).mount('#app')
    </script>
</body>
</html>